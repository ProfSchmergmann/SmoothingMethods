---
title: "HW6 - Lucas Fellmeth, Sven Bergmann"
date: "2023-11-29"
output: pdf_document
latex_engine: xelatex
---

```{r setup, echo = F}
library(knitr)
opts_chunk$set(tidy.opts = list(width.cutoff = 80), tidy = TRUE)
```
# 1
The goal of this problem is to estimate the regression function of acceleration vs time for the `mcycle` data in the package `MASS`, using cubic smoothing splines.

```{r}
library(MASS)
library(splines)
library(splines2)
```

## A
For a reasonable range of smoothing parameters $\lambda$, compute and plot the generalized cross validation measure $GCV(\lambda)$ and find the optimal smoothing parameter.

```{r, out.width = "50%", out.height = "50%"}
with(mcycle, {
  lambda <- seq(10^(-6), 10^(-3), by = 10^(-6))

  smoothing <- function(l, x, y) {
    return(smooth.spline(x, y, lambda = l)$cv.crit)
  }

  gcv <- sapply(lambda, smoothing, x = accel, y = times)
  tmp <- data.frame(lambda = lambda, gcv = gcv)
  lambda_opt <<- tmp[which.min(tmp$gcv),]$lambda
  plot(tmp, type = 'l')
  plot.new()
  plot(times, accel, main = paste('min_lambda =', lambda_opt))
  lines(smooth.spline(x = times, y = accel, lambda = lambda_opt), col = 'red', type = 'l')
})
```

## B
Using the Demmler-Reinsch basis representation, how many basis functions contribute significantly to the fit, as determined, for instance, by accumulating $90\%$ of the total degrees of freedom?

https://statisticaloddsandends.wordpress.com/2019/10/04/the-demmler-reinsch-basis-for-smoothing-splines/
```{r}
with(mcycle, {
  knots <- times
  Phi <- bSpline(times, knots = knots, degree = 3, intercept = T, Boundary.knots = c(0, length(knots)))
  t <- seq(0, 1, length.out = 500)
  delta <- t[2] - t[1]
  Phi2 <- bSpline(t, knots = knots, degree = 3, intercept = T, Boundary.knots = c(0, length(knots)), derivs = 2)
  Omega <- delta * t(Phi2) %*% Phi2
  H <- Phi %*% solve(t(Phi) %*% Phi + lambda_opt * Omega, t(Phi))
  trace <- sum(diag(H))
  GCV <- sum((y - H %*% y)^2) / (1 - mean(diag(H)))^2
  print(GCV)
  V <- eigen(t(Phi) %*% Phi)$vectors
  D2 <- eigen(t(Phi) %*% Phi)$values
})
```
